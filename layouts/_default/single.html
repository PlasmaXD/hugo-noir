{{ define "main" }}
<div class="max-w-5xl mx-auto py-12 px-4">
    <div
        class="mx-auto p-8 border border-border-primary-light dark:border-border-primary-dark rounded-2xl bg-neutral-50 dark:bg-neutral-800">
        <h1 class="text-4xl font-bold mb-4 text-text-primary-light dark:text-text-primary-dark">{{ .Title }}</h1>
        {{ if eq .Section "blogs" }}
        <div class="flex items-center gap-4 mb-8 text-text-secondary-light dark:text-text-secondary-dark">
            <time datetime="{{ .Date.Format " 2006-01-02" }}">{{ .Date.Format "January 2, 2006" }}</time>
            <div class="flex gap-2">
                {{ range .Params.tags }}
                <span
                    class="px-2 py-1 bg-bg-primary-light dark:bg-bg-tertiary-dark rounded-md text-xs font-medium text-text-secondary-light dark:text-text-secondary-dark">{{
                    . }}</span>
                {{ end }}
            </div>
        </div>
        {{ end }}

        <div class="prose dark:prose-invert max-w-none">
            {{ .Content }}
        </div>
    </div>
</div>

<style>
    /* --- Code block styling --- */
    .prose pre {
        background: #1a1a2e;
        border: 1px solid #3f3f46;
        border-radius: 0.75rem;
        padding: 1.25rem 1.5rem;
        margin: 1.25rem 0;
        overflow-x: auto;
        font-size: 0.875rem;
        line-height: 1.7;
    }

    .prose pre code {
        background: none;
        border: none;
        padding: 0;
        font-family: 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'Liberation Mono', monospace;
        color: #e4e4e7;
    }

    /* Inline code */
    .prose :not(pre)>code {
        background: #27272a;
        border: 1px solid #3f3f46;
        border-radius: 0.25rem;
        padding: 0.15rem 0.4rem;
        font-size: 0.85em;
        color: #f0abfc;
    }

    /* --- Copy button --- */
    .code-block-wrapper {
        position: relative;
    }

    .copy-btn {
        position: absolute;
        top: 0.75rem;
        right: 0.75rem;
        padding: 0.3rem 0.7rem;
        font-size: 0.75rem;
        font-family: inherit;
        color: #a1a1aa;
        background: rgba(39, 39, 42, 0.8);
        border: 1px solid #3f3f46;
        border-radius: 0.375rem;
        cursor: pointer;
        backdrop-filter: blur(4px);
        transition: background 0.2s, color 0.2s;
        z-index: 10;
    }

    .copy-btn:hover {
        background: #3f3f46;
        color: #e4e4e7;
    }

    .copy-btn.copied {
        color: #4ade80;
        border-color: #4ade80;
    }

    /* --- Table styling --- */
    .prose table {
        width: 100%;
        border-collapse: collapse;
        margin: 1.25rem 0;
        font-size: 0.9rem;
    }

    .prose th,
    .prose td {
        border: 1px solid #3f3f46;
        padding: 0.6rem 1rem;
        text-align: left;
    }

    .prose th {
        background: #27272a;
        font-weight: 600;
        color: #e4e4e7;
    }

    .prose tr:nth-child(even) {
        background: rgba(39, 39, 42, 0.3);
    }

    /* Light mode overrides */
    html:not(.dark) .prose th {
        background: #e5e7eb;
        color: #1f2937;
    }

    html:not(.dark) .prose th,
    html:not(.dark) .prose td {
        border-color: #d1d5db;
    }

    html:not(.dark) .prose tr:nth-child(even) {
        background: #f3f4f6;
    }

    /* Light mode code blocks */
    html:not(.dark) .prose pre {
        background: #f3f4f6;
        border-color: #d1d5db;
    }

    html:not(.dark) .prose pre code {
        color: #1f2937;
    }

    html:not(.dark) .prose :not(pre)>code {
        background: #e5e7eb;
        border-color: #d1d5db;
        color: #9333ea;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('pre').forEach(function (pre) {
            // Wrap pre in a relative container
            var wrapper = document.createElement('div');
            wrapper.className = 'code-block-wrapper';
            pre.parentNode.insertBefore(wrapper, pre);
            wrapper.appendChild(pre);

            // Create copy button
            var btn = document.createElement('button');
            btn.className = 'copy-btn';
            btn.textContent = 'Copy';
            btn.setAttribute('aria-label', 'Copy code to clipboard');
            wrapper.appendChild(btn);

            btn.addEventListener('click', function () {
                var code = pre.querySelector('code');
                var text = code ? code.textContent : pre.textContent;
                navigator.clipboard.writeText(text).then(function () {
                    btn.textContent = 'âœ“ Copied!';
                    btn.classList.add('copied');
                    setTimeout(function () {
                        btn.textContent = 'Copy';
                        btn.classList.remove('copied');
                    }, 2000);
                });
            });
        });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var isDark = document.documentElement.classList.contains('dark');
        mermaid.initialize({
            startOnLoad: false,
            theme: isDark ? 'dark' : 'default',
            securityLevel: 'loose'
        });

        // Convert ```mermaid code blocks to rendered diagrams
        document.querySelectorAll('pre code.language-mermaid').forEach(function (code) {
            var definition = code.textContent;
            var pre = code.parentNode;
            var mermaidDiv = document.createElement('div');
            mermaidDiv.className = 'mermaid';
            mermaidDiv.textContent = definition;
            pre.parentNode.replaceChild(mermaidDiv, pre);
        });

        mermaid.init(undefined, document.querySelectorAll('.mermaid'));
    });
</script>

<script type="module">
    import { D2 } from 'https://esm.sh/@terrastruct/d2@0.1.33';

    var d2Blocks = document.querySelectorAll('pre code.language-d2');
    if (d2Blocks.length > 0) {
        var d2 = new D2();
        d2Blocks.forEach(async function (code) {
            var definition = code.textContent;
            var pre = code.parentNode;

            // Show loading state
            var container = document.createElement('div');
            container.className = 'd2-diagram';
            container.style.textAlign = 'center';
            container.style.padding = '1rem';
            container.innerHTML = '<span style="color:#a1a1aa;">D2 Loading...</span>';
            pre.parentNode.replaceChild(container, pre);

            try {
                var result = await d2.compile(definition);
                var svg = await d2.render(result.diagram, result.renderOptions);
                container.innerHTML = svg;
            } catch (err) {
                container.innerHTML = '<pre style="color:#ef4444;">D2 Error: ' + err.message + '</pre>';
            }
        });
    }
</script>
{{ end }}